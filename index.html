<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ä—ã–≤ - –¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            padding: 10px;
            font-size: 14px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            overflow: hidden;
        }

        .header {
            background: var(--tg-theme-button-color, #3390ec);
            padding: 15px;
            color: var(--tg-theme-button-text-color, #ffffff);
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .month-selector {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 5px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        .stat-card {
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #3390ec);
            margin-bottom: 2px;
        }

        .stat-label {
            color: var(--tg-theme-hint-color, #707579);
            font-size: 11px;
        }

        .main-content {
            padding: 12px;
        }

        .tracker-section {
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .tracker-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            overflow: hidden;
            font-size: 12px;
        }

        .tracker-table th {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 8px 4px;
            font-weight: 500;
            text-align: center;
            font-size: 11px;
        }

        .tracker-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        .habit-row:hover {
            background-color: var(--tg-theme-secondary-bg-color, #f8f9fa);
        }

        .habit-name {
            text-align: left !important;
            font-weight: 500;
            padding-left: 8px !important;
            min-width: 120px;
            font-size: 11px;
        }

        .habit-icon {
            margin-right: 4px;
        }

        .goal-cell {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000000);
        }

        .day-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--tg-theme-button-color, #3390ec);
        }

        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chart-container {
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
            text-align: center;
        }

        .progress-overview {
            height: 180px;
        }

        .habits-progress {
            height: 200px;
        }

        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .week-separator {
            border-left: 2px solid var(--tg-theme-secondary-bg-color, #dee2e6) !important;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ Telegram */
        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 8px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .main-content {
                padding: 8px;
            }
            
            .tracker-table {
                font-size: 11px;
            }
            
            .tracker-table th,
            .tracker-table td {
                padding: 4px 2px;
            }

            .day-checkbox {
                width: 14px;
                height: 14px;
            }

            .habit-name {
                min-width: 100px;
                font-size: 10px;
            }

            .chart-container {
                padding: 8px;
            }

            .progress-overview {
                height: 150px;
            }

            .habits-progress {
                height: 160px;
            }
        }

        /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
        @media (max-width: 360px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .habit-name {
                min-width: 80px;
                font-size: 9px;
            }

            .day-checkbox {
                width: 12px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ –ü—Ä–æ—Ä—ã–≤</h1>
            <div class="month-selector">–°–µ–Ω—Ç—è–±—Ä—å 2025</div>
        </div>

        <!-- Statistics Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="totalCompleted">0</div>
                <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="averageProgress">0%</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="bestHabit">üìä</div>
                <div class="stat-label">–õ—É—á—à–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="currentStreak">0</div>
                <div class="stat-label">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tracker Table -->
            <div class="tracker-section">
                <table class="tracker-table">
                    <thead>
                        <tr>
                            <th>–ü—Ä–∏–≤—ã—á–∫–∏</th>
                            <th>–¶–µ–ª—å</th>
                            <!-- Week 1 -->
                            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                            <!-- Week 2 -->
                            <th class="week-separator">8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
                            <!-- Week 3 -->
                            <th class="week-separator">15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th>
                            <!-- Week 4 -->
                            <th class="week-separator">22</th><th>23</th><th>24</th><th>25</th><th>26</th><th>27</th><th>28</th>
                            <!-- Week 5 -->
                            <th class="week-separator">29</th><th>30</th>
                        </tr>
                    </thead>
                    <tbody id="habitsTable">
                        <!-- Habits will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Progress Overview Chart -->
                <div class="chart-container">
                    <div class="chart-title">üìä –û–±–∑–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
                    <div class="progress-overview">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- Habits Progress Chart -->
                <div class="chart-container">
                    <div class="chart-title">üìà –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    <div class="habits-progress">
                        <canvas id="habitsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-primary" onclick="exportCSV()">üì• CSV</button>
                <button class="btn btn-secondary" onclick="printTracker()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                <button class="btn btn-primary" onclick="copyData()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
            const themeParams = window.Telegram.WebApp.themeParams;
            if (themeParams.bg_color) {
                document.body.style.setProperty('--tg-theme-bg-color', themeParams.bg_color);
            }
            if (themeParams.text_color) {
                document.body.style.setProperty('--tg-theme-text-color', themeParams.text_color);
            }
            if (themeParams.button_color) {
                document.body.style.setProperty('--tg-theme-button-color', themeParams.button_color);
            }
            if (themeParams.button_text_color) {
                document.body.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color);
            }
        }

        // Habits data
        const habits = [
            { name: "üèÉ‚Äç‚ôÇÔ∏è –£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–±–µ–∂–∫–∞", goal: 20, icon: "üèÉ‚Äç‚ôÇÔ∏è" },
            { name: "üßò‚Äç‚ôÄÔ∏è –ú–µ–¥–∏—Ç–∞—Ü–∏—è", goal: 15, icon: "üßò‚Äç‚ôÄÔ∏è" },
            { name: "üèãÔ∏è‚Äç‚ôÇÔ∏è –°–ø–æ—Ä—Ç–∑–∞–ª", goal: 28, icon: "üèãÔ∏è‚Äç‚ôÇÔ∏è" },
            { name: "üìö –ß—Ç–µ–Ω–∏–µ", goal: 5, icon: "üìö" },
            { name: "üíß –í—ã–ø–∏–≤–∞—Ç—å 1–ª –≤–æ–¥—ã", goal: 30, icon: "üíß" },
            { name: "ü•ó –ü—Ä–∏—ë–º –≤–∏—Ç–∞–º–∏–Ω–æ–≤", goal: 30, icon: "ü•ó" },
            { name: "üè† –£–±–æ—Ä–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã", goal: 10, icon: "üè†" }
        ];

        const daysInMonth = 30; // –°–µ–Ω—Ç—è–±—Ä—å
        let habitData = {};

        // Initialize habit data
        function initializeHabits() {
            habits.forEach((habit, habitIndex) => {
                habitData[habitIndex] = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    habitData[habitIndex][day] = false;
                }
            });
        }

        // Create table rows
        function createHabitsTable() {
            const tbody = document.getElementById('habitsTable');
            tbody.innerHTML = '';

            habits.forEach((habit, habitIndex) => {
                const row = document.createElement('tr');
                row.className = 'habit-row';
                
                let rowHTML = `
                    <td class="habit-name">
                        <span class="habit-icon">${habit.icon}</span>
                        ${habit.name.replace(habit.icon, '').trim()}
                    </td>
                    <td class="goal-cell">${habit.goal}</td>
                `;

                for (let day = 1; day <= daysInMonth; day++) {
                    const isWeekStart = day === 8 || day === 15 || day === 22 || day === 29;
                    const extraClass = isWeekStart ? ' week-separator' : '';
                    
                    rowHTML += `
                        <td class="${extraClass}">
                            <input type="checkbox" 
                                   class="day-checkbox" 
                                   data-habit="${habitIndex}" 
                                   data-day="${day}"
                                   onchange="updateProgress()">
                        </td>
                    `;
                }

                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }

        // Charts
        let progressChart, habitsChart;

        function initializeCharts() {
            // Progress Overview Chart (Pie Chart)
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–û—Å—Ç–∞–ª–æ—Å—å'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            window.Telegram?.WebApp?.themeParams?.button_color || '#3390ec',
                            window.Telegram?.WebApp?.themeParams?.secondary_bg_color || '#f1f1f1'
                        ],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });

            // Habits Progress Chart (Bar Chart)
            const habitsCtx = document.getElementById('habitsChart').getContext('2d');
            habitsChart = new Chart(habitsCtx, {
                type: 'bar',
                data: {
                    labels: habits.map(h => h.icon),
                    datasets: [{
                        label: '–ü—Ä–æ–≥—Ä–µ—Å—Å (%)',
                        data: habits.map(() => 0),
                        backgroundColor: window.Telegram?.WebApp?.themeParams?.button_color || '#3390ec',
                        borderColor: window.Telegram?.WebApp?.themeParams?.button_color || '#3390ec',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update progress and send to n8n
        function updateProgress() {
            // Update habit data from checkboxes
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                const habitIndex = parseInt(checkbox.dataset.habit);
                const day = parseInt(checkbox.dataset.day);
                habitData[habitIndex][day] = checkbox.checked;
            });

            // Send data to n8n
            sendToN8N();

            // Calculate statistics
            let totalCompleted = 0;
            let totalPossible = 0;
            const habitProgress = [];

            habits.forEach((habit, habitIndex) => {
                let completed = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    if (habitData[habitIndex][day]) {
                        completed++;
                        totalCompleted++;
                    }
                    totalPossible++;
                }
                const progress = (completed / habit.goal) * 100;
                habitProgress.push(Math.min(progress, 100));
            });

            const averageProgress = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
            
            // Find best habit
            const bestHabitIndex = habitProgress.indexOf(Math.max(...habitProgress));
            const bestHabit = habits[bestHabitIndex];

            // Calculate current streak
            let currentStreak = 0;
            for (let day = daysInMonth; day >= 1; day--) {
                let dayComplete = false;
                habits.forEach((habit, habitIndex) => {
                    if (habitData[habitIndex][day]) {
                        dayComplete = true;
                    }
                });
                if (dayComplete) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            // Update statistics display
            document.getElementById('totalCompleted').textContent = totalCompleted;
            document.getElementById('averageProgress').textContent = averageProgress + '%';
            document.getElementById('bestHabit').textContent = bestHabit ? bestHabit.icon : 'üìä';
            document.getElementById('currentStreak').textContent = currentStreak;

            // Update charts
            progressChart.data.datasets[0].data = [averageProgress, 100 - averageProgress];
            progressChart.update();

            habitsChart.data.datasets[0].data = habitProgress;
            habitsChart.update();
        }

        // Send data to n8n webhook
        function sendToN8N() {
            const userData = {
                user_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'test_user',
                user_name: window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: window.Telegram?.WebApp?.initDataUnsafe?.user?.username || null,
                timestamp: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0],
                habits_data: habitData,
                habits_info: habits,
                month: 'september',
                year: 2025
            };

            fetch('https://n8n.meemugicopem.ru/webhook/habits-tracker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ n8n:', response.status);
                return response.json();
            })
            .catch(error => {
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ n8n (–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)');
            });
        }

        // Export functions
        function exportCSV() {
            let csv = '–ü—Ä–∏–≤—ã—á–∫–∞,–¶–µ–ª—å';
            for (let day = 1; day <= daysInMonth; day++) {
                csv += ',–î–µ–Ω—å ' + day;
            }
            csv += '\n';

            habits.forEach((habit, habitIndex) => {
                csv += `"${habit.name}",${habit.goal}`;
                for (let day = 1; day <= daysInMonth; day++) {
                    csv += ',' + (habitData[habitIndex][day] ? '1' : '0');
                }
                csv += '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'proryv-habits-september-2025.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printTracker() {
            window.print();
        }

        function copyData() {
            let text = '–ü—Ä–æ—Ä—ã–≤ - –¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫\\n\\n';
            text += '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\\n';
            text += `–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π: ${document.getElementById('totalCompleted').textContent}\\n`;
            text += `–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å: ${document.getElementById('averageProgress').textContent}\\n`;
            text += `–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è: ${document.getElementById('currentStreak').textContent} –¥–Ω–µ–π\\n\\n`;
            
            habits.forEach((habit, habitIndex) => {
                let completed = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    if (habitData[habitIndex][day]) completed++;
                }
                text += `${habit.name}: ${completed}/${habit.goal} –¥–Ω–µ–π\\n`;
            });

            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.showAlert('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    } else {
                        alert('–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                    }
                });
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initializeHabits();
            createHabitsTable();
            initializeCharts();
            updateProgress();
        });
    </script>
</body>
</html>
